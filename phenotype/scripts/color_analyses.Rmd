---
title: "Color Analysis of Floral Tissues"
author: "K. Uckele"
date: "`r Sys.Date()`"
output:
  pdf_document:
    toc: true
    toc_depth: '3'
  html_document:
    toc: true
    toc_depth: 3
    number_sections: true
---

# Introduction

This analysis explores the color properties of different floral tissues — bract, petal, and labellum — using spectral data sourced from Google Sheets. The analysis includes data loading, quality control, spectral processing, visualization, and the computation of summary descriptors.

# Setup

## Load Required Libraries
```{r load-libraries}
## libraries
library(googlesheets4)
library(cowplot)
library(dplyr)
library(tibble)
library(knitr)
library(rmarkdown)
library(pavo)
```

## Set working directory
```{r set-wd}
# Set the root directory to the project root
knitr::opts_knit$set(root.dir = normalizePath("../"))
```

## Define Custom Operators
```{r custom-operators}
# Define a 'not in' operator
`%notin%` = Negate(`%in%`)
```

## Authenticate Google Sheets Access
Authenticate access to Google Sheets using your email. Ensure that the email has the necessary permissions to access the sheets.
```{r authenticate}
# Authenticate with Google Sheets
gs4_auth(email = "kuckele@ucsc.edu")
```

# Quality Control

## Load Spectral Data from Google Sheets
We load the spectral data for bract, petal, and labellum from the specified Google Sheets.
```{r load-data}
# Specify the Google Sheets ID
sheet_id <- "12NWtlqKbLPAxU-rVBTqMQjY_6jH1DulVvNHS_QXAvFI"

# Load data for different floral tissues
bract <- read_sheet(ss = sheet_id, sheet = "Bract")
petal <- read_sheet(ss = sheet_id, sheet = "Petal")
labellum <- read_sheet(ss = sheet_id, sheet = "Labellum")
```

# Full Spectrum Analyses
## Spectral Data Processing
## Convert Data to rspec Objects
The spectral data is converted into rspec objects using the pavo package for further analysis.
```{r convert-to-rspec}
# Set seed for reproducibility
set.seed(1612217)

# Convert datasets to rspec objects with wavelength limits
bract_spec <- as.rspec(bract, lim = c(300, 700), whichwl = 1)
petal_spec <- as.rspec(petal, lim = c(300, 700), whichwl = 1)
labellum_spec <- as.rspec(labellum, lim = c(300, 700), whichwl = 1)

# change column names
colnames(bract_spec) <- gsub("-", "x", colnames(bract_spec))
colnames(petal_spec) <- gsub("-", "x", colnames(petal_spec))
colnames(labellum_spec) <- gsub("-", "x", colnames(labellum_spec))
```
Note: The conversion may produce warnings about negative values in spectral data, which are addressed in subsequent steps.

## Average the Spectra
Aggregate the spectral data by sample names, averaging replicates.
```{r aggregate}
# Extract sample names by removing trailing numbers in parentheses
bract_samples <- gsub("\\([0-9]+\\)$", "", names(bract_spec))[-1]
petal_samples <- gsub("\\([0-9]+\\)$", "", names(petal_spec))[-1]
labellum_samples <- gsub("\\([0-9]+\\)$", "", names(labellum_spec))[-1]

# Verify sample counts
table(bract_samples)
table(petal_samples)
table(labellum_samples)

# Aggregate spectra by sample names using mean
bract_spec_avg <- aggspec(bract_spec, by = bract_samples, FUN = mean)
petal_spec_avg <- aggspec(petal_spec, by = petal_samples, FUN = mean)
labellum_spec_avg <- aggspec(labellum_spec, by = labellum_samples, FUN = mean)
```

## Fix Negative Reflectance Values
Negative reflectance values are corrected by adding the minimum reflectance.

```{r negative-values}
# Fix negative values by adding the minimum reflectance
bract_spec_avg <- procspec(bract_spec_avg, fixneg = "addmin")
petal_spec_avg <- procspec(petal_spec_avg, fixneg = "addmin")
labellum_spec_avg <- procspec(labellum_spec_avg, fixneg = "addmin")
```

## Determine Smoothing Parameter
Use plotsmooth to visualize and decide on an appropriate smoothing span.
```{r determine-smoothing}
# Plot to determine suitable smoothing span
plotsmooth(bract_spec_avg[,1:7],
           minsmooth = 0.05,
           maxsmooth = 0.5,
           curves = 4,
           ask = FALSE)
```
Choose a span (e.g., 0.2) based on the plot to balance smoothness and data fidelity.

## Smooth the Spectral Data
Apply smoothing to the spectral data using the chosen span.
```{r apply-smoothing}
# Apply smoothing with span = 0.2
bract_spec_sm <- procspec(bract_spec_avg, opt = "smooth", span = 0.2)
petal_spec_sm <- procspec(petal_spec_avg, opt = "smooth", span = 0.2)
labellum_spec_sm <- procspec(labellum_spec_avg, opt = "smooth", span = 0.2)
```

## Scale the Spectral Data
Scale the spectral data to different reference points for comparative analysis.
```{r scale}
# Scale spectra to both minimum and maximum reflectance
bract_spec_scaleminmax <- procspec(bract_spec_sm, opt = c("min", "max"))
petal_spec_scaleminmax <- procspec(petal_spec_sm, opt = c("min", "max"))
labellum_spec_scaleminmax <- procspec(labellum_spec_sm, opt = c("min", "max"))
```

## Plot Processed Spectra
Visualize the processed spectral data for each floral tissue, highlighting specific samples.

## Define Common Plotting Parameters
```{r define-params}
# Define a color palette for highlighting specific samples
highlight_colors <- c(rep("lightgrey", 170), "gold1", "gold1", "darkgreen")
```

## Bract Spectra Plot
```{r bract-spectra}
# Order samples to highlight specific ones
order_spec_bract <- c(
  which(names(bract_spec_scaleminmax) == "125"),
  which(names(bract_spec_scaleminmax) == "126"),
  which(names(bract_spec_scaleminmax) == "BRAC")
)

# Reorder columns to place highlighted samples at the end
columns_bract <- 1:ncol(bract_spec_scaleminmax)
order_spec_bract <- c(columns_bract[columns_bract %notin% order_spec_bract], order_spec_bract)

# Plot the spectra
plot(bract_spec_scaleminmax[order_spec_bract], type = "o",
     col = highlight_colors, main = "Bract Spectra",
     xlab = "Wavelength (nm)", ylab = "Reflectance (%)")

# Add a legend
legend("topleft", legend = c("C. bracteatus parent", "C. lasius parent"),
       col = c("darkgreen", "gold1"), lty = 1, cex = 0.8)
```

## Petal Spectra Plot
```{r petal-spectra}
# Order samples to highlight specific ones
order_spec_petal <- c(
  which(names(petal_spec_scaleminmax) == "125"),
  which(names(petal_spec_scaleminmax) == "126"),
  which(names(petal_spec_scaleminmax) == "BRAC")
)

# Reorder columns to place highlighted samples at the end
columns_petal <- 1:ncol(petal_spec_scaleminmax)
order_spec_petal <- c(columns_petal[columns_petal %notin% order_spec_petal], order_spec_petal)

# Plot the spectra
plot(petal_spec_scaleminmax[order_spec_petal], type = "o",
     col = highlight_colors, main = "Petal Spectra",
     xlab = "Wavelength (nm)", ylab = "Reflectance (%)")

# Add a legend
legend("topleft", legend = c("C. bracteatus parent", "C. lasius parent"),
       col = c("darkgreen", "gold1"), lty = 1, cex = 0.8)
```

## Labellum Spectra Plot
```{r labellum-spectra}
# Order samples to highlight specific ones
order_spec_labellum <- c(
  which(names(labellum_spec_scaleminmax) == "125"),
  which(names(labellum_spec_scaleminmax) == "126"),
  which(names(labellum_spec_scaleminmax) == "BRAC")
)

# Reorder columns to place highlighted samples at the end
columns_labellum <- 1:ncol(labellum_spec_scaleminmax)
order_spec_labellum <- c(columns_labellum[columns_labellum %notin% order_spec_labellum], order_spec_labellum)

# Plot the spectra
plot(labellum_spec_scaleminmax[order_spec_labellum], type = "o",
     col = highlight_colors, main = "Labellum Spectra",
     xlab = "Wavelength (nm)", ylab = "Reflectance (%)")

# Add a legend
legend("topleft", legend = c("C. bracteatus parent", "C. lasius parent"),
       col = c("darkgreen", "gold1"), lty = 1, cex = 0.8)
```

## Combine and Save Spectral Plots with Highlighted Parents
```{r save-plots}
# Save combined spectra plots with highlighted parental samples
pdf("./results/figures/Combined_Spectra_Bract_Petal_Labellum_Cbracteatus_Clasius_hybrids.pdf", width = 30, height = 7)
par(mfrow = c(1, 3))
# Increase left margin to provide more space for y-axis labels
par(mar = c(5, 5, 4, 2) + 0.1)  # c(bottom, left, top, right)
plot(bract_spec_scaleminmax[order_spec_bract], type = "o", col = highlight_colors, 
     main = "Bract spectra", xlab = "Wavelength (nm)", ylab = "Reflectance (%)",
     cex.main = 3, cex.lab = 2.5, cex.axis = 2, lwd = 2) 
legend("topleft", legend = c("C. bracteatus parent", "C. lasius parent"),
       col = c("darkgreen", "gold1"), lty = 1, cex = 2.5, bty = "n")
plot(petal_spec_scaleminmax[order_spec_petal], type = "o", col = highlight_colors, 
     main = "Petal spectra", xlab = "Wavelength (nm)", ylab = "Reflectance (%)",
     cex.main = 3, cex.lab = 2.5, cex.axis = 2, lwd = 2)
legend("topleft", legend = c("C. bracteatus parent", "C. lasius parent"),
       col = c("darkgreen", "gold1"), lty = 1, cex = 2.5, bty = "n")
plot(labellum_spec_scaleminmax[order_spec_labellum], type = "o", col = highlight_colors, 
     main = "Labellum spectra", xlab = "Wavelength (nm)", ylab = "Reflectance (%)",
     cex.main = 3, cex.lab = 2.5, cex.axis = 2, lwd = 2)
legend("topleft", legend = c("C. bracteatus parent", "C. lasius parent"),
       col = c("darkgreen", "gold1"), lty = 1, cex = 2.5, bty = "n")
dev.off()
```

## Principal component analysis - Bract 
```{r}
# opt = 'center' centers the spectra to have a mean reflectance of zero (thus removing brightness as a dominant variable in the PCA)
# opt = 'bin' bins the spectra into user-defined bins
spec.bin <- procspec(bract_spec_scaleminmax, opt = c("bin", "center"))

# Transpose so wavelength are variables for the PCA
spec.bin <- t(spec.bin)

# Names variables as wavelength bins
colnames(spec.bin) <- spec.bin[1, ]
spec.bin <- spec.bin[-1, ] # remove 'wl' row

# Run PCA on the processed spectra data
pca1 <- prcomp(spec.bin, scale. = TRUE)
(summary_pca <- summary(pca1))
plot(summary_pca$importance[2,])

# Convert column names (wavelength bins) to numeric values and assign to 'wls'
wls <- as.numeric(colnames(spec.bin))

# Plot loadings of the first principal component (PC1)
plot(pca1$rotation[, 1] ~ wls, type = "l", ylab = "PC1 loading")
abline(h = 0, lty = 2)
## appears to contrast shorter wavelengths (300-570 nm) with long wavelengths 
## (570-700 nm)

# Plot loadings of the second principal component (PC2)
plot(pca1$rotation[, 2] ~ wls, type = "l", ylab = "PC2 loading")
abline(h = 0, lty = 2)
## confusing. UV wavelengths (300-400) are correlated with warm colors 
## (520-630 nm -- green, yellow, orange, red)
## cool wavelengths (400-520 nm) are correlated with hot colors (630-700 nm -- red)

# Plot loadings of the third principal component (PC2)
plot(pca1$rotation[, 3] ~ wls, type = "l", ylab = "PC3 loading")
abline(h = 0, lty = 2) 
## Confusing. wavelengths 490-610 nm (huge range including most of visible light) 
## are contrasted with <490 nm (UV and dark blue/violet) and >610 nm (orange/red)

# Extracting PCA Scores
pca_bract <- cbind(pca1$x[,1], pca1$x[,2], pca1$x[,3])
colnames(pca_bract) <- c("PC1_bract", "PC2_bract", "PC3_bract")
```
## Principal component analysis - Petal 
```{r}
# opt = 'center' centers the spectra to have a mean reflectance of zero (thus removing brightness as a dominant variable in the PCA)
# opt = 'bin' bins the spectra into user-defined bins
spec.bin <- procspec(petal_spec_scaleminmax, opt = c("bin", "center"))

# Transpose so wavelength are variables for the PCA
spec.bin <- t(spec.bin)

# Names variables as wavelength bins
colnames(spec.bin) <- spec.bin[1, ]
spec.bin <- spec.bin[-1, ] # remove 'wl' row

# Run PCA on the processed spectra data
pca1 <- prcomp(spec.bin, scale. = TRUE)
(summary_pca <- summary(pca1))
plot(summary_pca$importance[2,])

# Convert column names (wavelength bins) to numeric values and assign to 'wls'
wls <- as.numeric(colnames(spec.bin))

# Plot loadings of the first principal component (PC1)
plot(pca1$rotation[, 1] ~ wls, type = "l", ylab = "PC1 loading")
abline(h = 0, lty = 2)
## appears to contrast short wavelengths (310-510 nm) with long wavelengths 
## (510-700 nm)

# Plot loadings of the second principal component (PC2)
plot(pca1$rotation[, 2] ~ wls, type = "l", ylab = "PC2 loading")
abline(h = 0, lty = 2)
## appears to be associated with the UV range (300-400 nm)

# Plot loadings of the third principal component (PC2)
plot(pca1$rotation[, 3] ~ wls, type = "l", ylab = "PC3 loading")
abline(h = 0, lty = 2) 
## appears to be associated with wavelengths 500-550 nm (green)

# Extracting PCA Scores
pca_petal <- cbind(pca1$x[,1], pca1$x[,2], pca1$x[,3])
colnames(pca_petal) <- c("PC1_petal", "PC2_petal", "PC3_petal")
```

## Principal component analysis - Labellum 
```{r}
# opt = 'center' centers the spectra to have a mean reflectance of zero (thus removing brightness as a dominant variable in the PCA)
# opt = 'bin' bins the spectra into user-defined bins
spec.bin <- procspec(labellum_spec_scaleminmax, opt = c("bin", "center"))

# Transpose so wavelength are variables for the PCA
spec.bin <- t(spec.bin)

# Names variables as wavelength bins
colnames(spec.bin) <- spec.bin[1, ]
spec.bin <- spec.bin[-1, ] # remove 'wl' row

# Run PCA on the processed spectra data
pca1 <- prcomp(spec.bin, scale. = TRUE)
(summary_pca <- summary(pca1))
plot(summary_pca$importance[2,])

# Convert column names (wavelength bins) to numeric values and assign to 'wls'
wls <- as.numeric(colnames(spec.bin))

# Plot loadings of the first principal component (PC1)
plot(pca1$rotation[, 1] ~ wls, type = "l", ylab = "PC1 loading")
abline(h = 0, lty = 2)
## appears to contrast shorter wavelengths (300-520 nm) with long wavelengths 
## (520-700 nm)

# Plot loadings of the second principal component (PC2)
plot(pca1$rotation[, 2] ~ wls, type = "l", ylab = "PC2 loading")
abline(h = 0, lty = 2)
## appears to be associated with UV wavelengths (300-390 nm)

# Plot loadings of the third principal component (PC2)
plot(pca1$rotation[, 3] ~ wls, type = "l", ylab = "PC3 loading")
abline(h = 0, lty = 2) 
## appears to be associated with wavelengths 500-570 nm (green, yellow)

# Extracting PCA Scores
pca_labellum <- cbind(pca1$x[,1], pca1$x[,2], pca1$x[,3])
colnames(pca_labellum) <- c("PC1_labellum", "PC2_labellum", "PC3_labellum")
```
## Format PC Scores 
```{r}
# Replace 'x' with '_' in row names
rownames(pca_bract) <- gsub("x", "_", rownames(pca_bract))
rownames(pca_petal) <- gsub("x", "_", rownames(pca_petal))
rownames(pca_labellum) <- gsub("x", "_", rownames(pca_labellum))

# Convert row names to a column named 'id'
pca_bract <- pca_bract %>% rownames_to_column(var = "id")
pca_petal <- pca_petal %>% rownames_to_column(var = "id")
pca_labellum <- pca_labellum %>% rownames_to_column(var = "id")
```
## Spectral Descriptors
We compute various spectral descriptors to quantify the color properties of the floral tissues.

## Define spectral descriptors
B1: Total brightness
B2: Mean brightness
B3: Intensity (Rmax)
S1U to S1R: Relative contributions of UV, Violet, Blue, Green, Yellow, and Red spectral ranges to total brightness
S2: Spectral saturation (Rmax/Rmin)
S3: Chroma
S4: Spectral purity
S5: Chroma
S6: Contrast (Rmax - Rmin)
S7: Spectral saturation
S8: Chroma ((Rmax - Rmin)/B2)
S9: Carotenoid chroma ((R700 - R450)/R700)
S10: Peaky chroma
H1 to H5: Hue metrics (e.g., peak wavelength)
Note: Some metrics may be sensitive to spectral noise.

## Calculate Spectral Descriptors
### Bract 

```{r bract-summary}
# Calculate spectral descriptors for bract
summary_bract <- summary(bract_spec_scaleminmax)

# Remove S2 due to infinite values
summary_bract <- summary_bract %>% select(-S2)

# Extract metrics for parents
bract125 <- round(summary_bract["125", ], 3)
bract126 <- round(summary_bract["126", ], 3)
bractBRAC <- round(summary_bract["BRAC", ], 3)
```

### Plot Bract Spectral Descriptors Histograms
```{r plot-bract-hist}

pdf("./results/figures/bract_descriptors_histograms.pdf", width = 14, height = 10)

# Set up plotting area: 4 rows x 6 columns for histograms
par(mfrow = c(4, 6),        # 4 rows, 6 columns
    mar = c(5, 5, 4, 2) + 0.1,  # Margins for each plot: bottom, left, top, right
    oma = c(0, 0, 0, 5))    # Outer margins: bottom, left, top, right

# Loop through each metric and plot histogram with parental lines
for (i in 1:ncol(summary_bract)) {
  hist(summary_bract[, i], 
       xlab = colnames(summary_bract)[i], 
       main = colnames(summary_bract)[i],
       col = "lightgrey", 
       border = "white")
  
  # Add vertical lines for parental samples
  abline(v = bract125[i], col = 'gold1', lwd = 3)      # C. lasius parent
  abline(v = bract126[i], col = 'gold1', lwd = 3)      # C. lasius parent
  abline(v = bractBRAC[i], col = 'darkgreen', lwd = 3) # C. bracteatus parent
}

# Allow drawing in the outer margin
par(xpd = TRUE)

plot.new()

# Add a shared legend in the outer right margin
legend("topright",
       inset = c(0, 0),  # Adjusts the position of the legend
       legend = c("C. lasius parent", "C. bracteatus parent"),
       col = c("gold1", "darkgreen"),
       lty = 1,              # Line type: solid
       lwd = 3,              # Line width
       cex = 1.5,            # Text size
       bty = "n")            # No box around the legend

# Close the PDF device to save the file
dev.off()
```

### Petal Summary
```{r petal-summary}
# Calculate summary statistics for petal
summary_petal <- summary(petal_spec_scaleminmax)

# Remove S2 due to infinite values
summary_petal <- summary_petal %>% select(-S2)

# Extract metrics for specific samples
petal125 <- round(summary_petal["125", ], 3)
petal126 <- round(summary_petal["126", ], 3)
petalBRAC <- round(summary_petal["BRAC", ], 3)
```

### Plot Petal Spectral Descriptors Histograms
```{r plot-petal-hist}
pdf("./results/figures/petal_descriptors_histograms.pdf", width = 14, height = 10)

# Set up plotting area: 4 rows x 6 columns for histograms
par(mfrow = c(4, 6),        # 4 rows, 6 columns
    mar = c(5, 5, 4, 2) + 0.1,  # Margins for each plot: bottom, left, top, right
    oma = c(0, 0, 0, 5))    # Outer margins: bottom, left, top, right

# Loop through each metric and plot histogram with parental lines
for (i in 1:ncol(summary_petal)) {
  hist(summary_petal[, i], 
       xlab = colnames(summary_petal)[i], 
       main = colnames(summary_petal)[i],
       col = "lightgrey", 
       border = "white")
  
  # Add vertical lines for parental samples
  abline(v = petal125[i], col = 'gold1', lwd = 3)      # C. lasius parent
  abline(v = petal126[i], col = 'gold1', lwd = 3)      # C. lasius parent
  abline(v = petalBRAC[i], col = 'darkgreen', lwd = 3) # C. bracteatus parent
}

# Allow drawing in the outer margin
par(xpd = TRUE)

plot.new()

# Add a shared legend in the outer right margin
legend("topright",
       inset = c(0, 0),  # Adjusts the position of the legend
       legend = c("C. lasius parent", "C. bracteatus parent"),
       col = c("gold1", "darkgreen"),
       lty = 1,              # Line type: solid
       lwd = 3,              # Line width
       cex = 1.5,            # Text size
       bty = "n")            # No box around the legend

# Close the PDF device to save the file
dev.off()
```

### Labellum Summary
```{r labellum-summary}
# Calculate summary statistics for labellum
summary_labellum <- summary(labellum_spec_scaleminmax)

# Remove S2 due to infinite values
summary_labellum <- summary_labellum %>% select(-S2)

# Extract metrics for specific samples
labellum125 <- round(summary_labellum["125", ], 3)
labellum126 <- round(summary_labellum["126", ], 3)
labellumBRAC <- round(summary_labellum["BRAC", ], 3)
```

### Plot Labellum Spectral Descriptors Histograms
```{r plot-labellum-hist}
pdf("./results/figures/labellum_descriptors_histograms.pdf", width = 14, height = 10)

# Set up plotting area: 4 rows x 6 columns for histograms
par(mfrow = c(4, 6),        # 4 rows, 6 columns
    mar = c(5, 5, 4, 2) + 0.1,  # Margins for each plot: bottom, left, top, right
    oma = c(0, 0, 0, 5))    # Outer margins: bottom, left, top, right

# Loop through each metric and plot histogram with parental lines
for (i in 1:ncol(summary_labellum)) {
  hist(summary_labellum[, i], 
       xlab = colnames(summary_labellum)[i], 
       main = colnames(summary_labellum)[i],
       col = "lightgrey", 
       border = "white")
  
  # Add vertical lines for parental samples
  abline(v = labellum125[i], col = 'gold1', lwd = 3)      # C. lasius parent
  abline(v = labellum126[i], col = 'gold1', lwd = 3)      # C. lasius parent
  abline(v = labellumBRAC[i], col = 'darkgreen', lwd = 3) # C. bracteatus parent
}

# Allow drawing in the outer margin
par(xpd = TRUE)

plot.new()

# Add a shared legend in the outer right margin
legend("topright",
       inset = c(0, 0),  # Adjusts the position of the legend
       legend = c("C. lasius parent", "C. bracteatus parent"),
       col = c("gold1", "darkgreen"),
       lty = 1,              # Line type: solid
       lwd = 3,              # Line width
       cex = 1.5,            # Text size
       bty = "n")            # No box around the legend

# Close the PDF device to save the file
dev.off()
```

## Data Formatting and Export
## Reformat Rownames
Replace 'x' with '_' in row names for consistency.
```{r }
# Replace 'x' with '_' in row names
rownames(summary_bract) <- gsub("x", "_", rownames(summary_bract))
rownames(summary_petal) <- gsub("x", "_", rownames(summary_petal))
rownames(summary_labellum) <- gsub("x", "_", rownames(summary_labellum))
```

## Subset and Rename Columns
Select relevant metrics and rename columns to indicate their corresponding floral tissue.
```{r select-rename}
# Subset relevant columns based on analysis needs
summary_bract <- summary_bract[, c("S1U", "S1V", "S1B", "S1G", "S1R", "S5", "S9", "H4")]
summary_petal <- summary_petal[, c("B3", "S1U", "S1V", "S1B", "S1Y", "S1R", "S5", "S9", "H4")]
summary_labellum <- summary_labellum[, c("B3", "S1B", "S1Y", "S1R", "S5", "S6", "S9", "H3", "H4")]

# Rename columns to include tissue type
colnames(summary_bract) <- c("S1U_bract", "S1V_bract", "S1B_bract", "S1G_bract", 
                             "S1R_bract", "S5_bract", "S9_bract", "H4_bract")
colnames(summary_petal) <- c("B3_petal", "S1U_petal", "S1V_petal", "S1B_petal", 
                             "S1Y_petal", "S1R_petal", "S5_petal", "S9_petal", "H4_petal")
colnames(summary_labellum) <- c("B3_labellum", "S1B_labellum", "S1Y_labellum", 
                                "S1R_labellum", "S5_labellum", "S6_labellum", 
                                "S9_labellum", "H3_labellum", "H4_labellum")
```

## Convert Rownames to a Column
Add the row names as a new column id to facilitate merging.
```{r convert}
# Convert row names to a column named 'id'
summary_bract <- summary_bract %>% rownames_to_column(var = "id")
summary_petal <- summary_petal %>% rownames_to_column(var = "id")
summary_labellum <- summary_labellum %>% rownames_to_column(var = "id")
```


# UV Analyses
## Spectral Data Processing
## Convert Data to rspec Objects
The spectral data is converted into rspec objects using the pavo package for further analysis.
```{r convert-to-rspec UV}
# Set seed for reproducibility
set.seed(1612217)

# Convert datasets to rspec objects with wavelength limits
bract_spec <- as.rspec(bract, lim = c(300, 400), whichwl = 1)
petal_spec <- as.rspec(petal, lim = c(300, 400), whichwl = 1)
labellum_spec <- as.rspec(labellum, lim = c(300, 400), whichwl = 1)

# change column names
colnames(bract_spec) <- gsub("-", "x", colnames(bract_spec))
colnames(petal_spec) <- gsub("-", "x", colnames(petal_spec))
colnames(labellum_spec) <- gsub("-", "x", colnames(labellum_spec))
```
Note: The conversion may produce warnings about negative values in spectral data, which are addressed in subsequent steps.

## Average the Spectra
Aggregate the spectral data by sample names, averaging replicates.
```{r aggregate UV}
# Extract sample names by removing trailing numbers in parentheses
bract_samples <- gsub("\\([0-9]+\\)$", "", names(bract_spec))[-1]
petal_samples <- gsub("\\([0-9]+\\)$", "", names(petal_spec))[-1]
labellum_samples <- gsub("\\([0-9]+\\)$", "", names(labellum_spec))[-1]

# Verify sample counts
table(bract_samples)
table(petal_samples)
table(labellum_samples)

# Aggregate spectra by sample names using mean
bract_spec_avg <- aggspec(bract_spec, by = bract_samples, FUN = mean)
petal_spec_avg <- aggspec(petal_spec, by = petal_samples, FUN = mean)
labellum_spec_avg <- aggspec(labellum_spec, by = labellum_samples, FUN = mean)
```

## Fix Negative Reflectance Values
Negative reflectance values are corrected by adding the minimum reflectance.

```{r negative-values UV}
# Fix negative values by adding the minimum reflectance
bract_spec_avg <- procspec(bract_spec_avg, fixneg = "addmin")
petal_spec_avg <- procspec(petal_spec_avg, fixneg = "addmin")
labellum_spec_avg <- procspec(labellum_spec_avg, fixneg = "addmin")
```

## Determine Smoothing Parameter
Use plotsmooth to visualize and decide on an appropriate smoothing span.
```{r determine-smoothing UV}
# Plot to determine suitable smoothing span
plotsmooth(bract_spec_avg[,1:7],
           minsmooth = 0.05,
           maxsmooth = 0.5,
           curves = 4,
           ask = FALSE)
```
Choose a span (e.g., 0.2) based on the plot to balance smoothness and data fidelity.

## Smooth the Spectral Data
Apply smoothing to the spectral data using the chosen span.
```{r apply-smoothing UV}
# Apply smoothing with span = 0.2
bract_spec_sm <- procspec(bract_spec_avg, opt = "smooth", span = 0.2)
petal_spec_sm <- procspec(petal_spec_avg, opt = "smooth", span = 0.2)
labellum_spec_sm <- procspec(labellum_spec_avg, opt = "smooth", span = 0.2)
```

## Scale the Spectral Data
Scale the spectral data to different reference points for comparative analysis.
```{r scale UV}
# Scale spectra to both minimum and maximum reflectance
bract_spec_scaleminmax <- procspec(bract_spec_sm, opt = c("min", "max"))
petal_spec_scaleminmax <- procspec(petal_spec_sm, opt = c("min", "max"))
labellum_spec_scaleminmax <- procspec(labellum_spec_sm, opt = c("min", "max"))
```

## Plot Processed Spectra
Visualize the processed spectral data for each floral tissue, highlighting specific samples.

## Define Common Plotting Parameters
```{r define-params UV}
# Define a color palette for highlighting specific samples
highlight_colors <- c(rep("lightgrey", 170), "gold1", "gold1", "darkgreen")
```

## Bract Spectra Plot
```{r bract-spectra UV}
# Order samples to highlight specific ones
order_spec_bract <- c(
  which(names(bract_spec_scaleminmax) == "125"),
  which(names(bract_spec_scaleminmax) == "126"),
  which(names(bract_spec_scaleminmax) == "BRAC")
)

# Reorder columns to place highlighted samples at the end
columns_bract <- 1:ncol(bract_spec_scaleminmax)
order_spec_bract <- c(columns_bract[columns_bract %notin% order_spec_bract], order_spec_bract)

# Plot the spectra
plot(bract_spec_scaleminmax[order_spec_bract], type = "o",
     col = highlight_colors, main = "Bract Spectra",
     xlab = "Wavelength (nm)", ylab = "Reflectance (%)")

# Add a legend
legend("topleft", legend = c("C. bracteatus parent", "C. lasius parent"),
       col = c("darkgreen", "gold1"), lty = 1, cex = 0.8)
```

## Petal Spectra Plot
```{r petal-spectra UV}
# Order samples to highlight specific ones
order_spec_petal <- c(
  which(names(petal_spec_scaleminmax) == "125"),
  which(names(petal_spec_scaleminmax) == "126"),
  which(names(petal_spec_scaleminmax) == "BRAC")
)

# Reorder columns to place highlighted samples at the end
columns_petal <- 1:ncol(petal_spec_scaleminmax)
order_spec_petal <- c(columns_petal[columns_petal %notin% order_spec_petal], order_spec_petal)

# Plot the spectra
plot(petal_spec_scaleminmax[order_spec_petal], type = "o",
     col = highlight_colors, main = "Petal Spectra",
     xlab = "Wavelength (nm)", ylab = "Reflectance (%)")

# Add a legend
legend("topleft", legend = c("C. bracteatus parent", "C. lasius parent"),
       col = c("darkgreen", "gold1"), lty = 1, cex = 0.8)
```

## Labellum Spectra Plot
```{r labellum-spectra UV}
# Order samples to highlight specific ones
order_spec_labellum <- c(
  which(names(labellum_spec_scaleminmax) == "125"),
  which(names(labellum_spec_scaleminmax) == "126"),
  which(names(labellum_spec_scaleminmax) == "BRAC")
)

# Reorder columns to place highlighted samples at the end
columns_labellum <- 1:ncol(labellum_spec_scaleminmax)
order_spec_labellum <- c(columns_labellum[columns_labellum %notin% order_spec_labellum], order_spec_labellum)

# Plot the spectra
plot(labellum_spec_scaleminmax[order_spec_labellum], type = "o",
     col = highlight_colors, main = "Labellum Spectra",
     xlab = "Wavelength (nm)", ylab = "Reflectance (%)")

# Add a legend
legend("topleft", legend = c("C. bracteatus parent", "C. lasius parent"),
       col = c("darkgreen", "gold1"), lty = 1, cex = 0.8)
```

## Combine and Save Spectral Plots with Highlighted Parents
```{r save-plots UV}
# Save combined spectra plots with highlighted parental samples
pdf("./results/figures/Combined_UVspectra_Bract_Petal_Labellum_Cbracteatus_Clasius_hybrids.pdf", width = 30, height = 7)
par(mfrow = c(1, 3))
# Increase left margin to provide more space for y-axis labels
par(mar = c(5, 5, 4, 2) + 0.1)  # c(bottom, left, top, right)
plot(bract_spec_scaleminmax[order_spec_bract], type = "o", col = highlight_colors, 
     main = "Bract spectra", xlab = "Wavelength (nm)", ylab = "Reflectance (%)",
     cex.main = 3, cex.lab = 2.5, cex.axis = 2, lwd = 2) 
legend("topleft", legend = c("C. bracteatus parent", "C. lasius parent"),
       col = c("darkgreen", "gold1"), lty = 1, cex = 2.5, bty = "n")
plot(petal_spec_scaleminmax[order_spec_petal], type = "o", col = highlight_colors, 
     main = "Petal spectra", xlab = "Wavelength (nm)", ylab = "Reflectance (%)",
     cex.main = 3, cex.lab = 2.5, cex.axis = 2, lwd = 2)
legend("topleft", legend = c("C. bracteatus parent", "C. lasius parent"),
       col = c("darkgreen", "gold1"), lty = 1, cex = 2.5, bty = "n")
plot(labellum_spec_scaleminmax[order_spec_labellum], type = "o", col = highlight_colors, 
     main = "Labellum spectra", xlab = "Wavelength (nm)", ylab = "Reflectance (%)",
     cex.main = 3, cex.lab = 2.5, cex.axis = 2, lwd = 2)
legend("topleft", legend = c("C. bracteatus parent", "C. lasius parent"),
       col = c("darkgreen", "gold1"), lty = 1, cex = 2.5, bty = "n")
dev.off()
```

## Spectral Descriptors
We compute various spectral descriptors to quantify the color properties of the floral tissues.

## Define spectral descriptors
B1: Total brightness
B2: Mean brightness
B3: Intensity (Rmax)
S1U to S1R: Relative contributions of UV, Violet, Blue, Green, Yellow, and Red spectral ranges to total brightness
S2: Spectral saturation (Rmax/Rmin)
S3: Chroma
S4: Spectral purity
S5: Chroma
S6: Contrast (Rmax - Rmin)
S7: Spectral saturation
S8: Chroma ((Rmax - Rmin)/B2)
S9: Carotenoid chroma ((R700 - R450)/R700)
S10: Peaky chroma
H1 to H5: Hue metrics (e.g., peak wavelength)
Note: Some metrics may be sensitive to spectral noise.

## Calculate Spectral Descriptors
### Bract 

```{r bract-summary UV}
# Calculate spectral descriptors for bract
summary_bract_UV <- summary(bract_spec_scaleminmax)

# Remove S2 due to infinite values
summary_bract_UV <- summary_bract_UV %>% select(-S2)

# Extract metrics for parents
bract125 <- round(summary_bract_UV["125", ], 3)
bract126 <- round(summary_bract_UV["126", ], 3)
bractBRAC <- round(summary_bract_UV["BRAC", ], 3)
```

### Plot Bract Spectral Descriptors Histograms
```{r plot-bract-hist UV}

pdf("./results/figures/bract_UV_descriptors_histograms.pdf", width = 14, height = 10)

# Set up plotting area: 4 rows x 6 columns for histograms
par(mfrow = c(4, 6),        # 4 rows, 6 columns
    mar = c(5, 5, 4, 2) + 0.1,  # Margins for each plot: bottom, left, top, right
    oma = c(0, 0, 0, 5))    # Outer margins: bottom, left, top, right

# Loop through each metric and plot histogram with parental lines
for (i in 1:ncol(summary_bract_UV)) {
  
  if (!any(!is.na(summary_bract_UV[, i]))) next  # Skip columns that are entirely NA

  hist(summary_bract_UV[, i], 
       xlab = colnames(summary_bract_UV)[i], 
       main = colnames(summary_bract_UV)[i],
       col = "lightgrey", 
       border = "white")
  
  # Add vertical lines for parental samples
  abline(v = bract125[i], col = 'gold1', lwd = 3)      # C. lasius parent
  abline(v = bract126[i], col = 'gold1', lwd = 3)      # C. lasius parent
  abline(v = bractBRAC[i], col = 'darkgreen', lwd = 3) # C. bracteatus parent
}

# Allow drawing in the outer margin
par(xpd = TRUE)

plot.new()

# Add a shared legend in the outer right margin
legend("topright",
       inset = c(0, 0),  # Adjusts the position of the legend
       legend = c("C. lasius parent", "C. bracteatus parent"),
       col = c("gold1", "darkgreen"),
       lty = 1,              # Line type: solid
       lwd = 3,              # Line width
       cex = 1.5,            # Text size
       bty = "n")            # No box around the legend

# Close the PDF device to save the file
dev.off()
```

### Petal Summary
```{r petal-summary UV}
# Calculate summary statistics for petal
summary_petal_UV <- summary(petal_spec_scaleminmax)

# Remove S2 due to infinite values
summary_petal_UV <- summary_petal_UV %>% select(-S2)

# Extract metrics for specific samples
petal125 <- round(summary_petal_UV["125", ], 3)
petal126 <- round(summary_petal_UV["126", ], 3)
petalBRAC <- round(summary_petal_UV["BRAC", ], 3)
```

### Plot Petal Spectral Descriptors Histograms
```{r plot-petal-hist UV}
pdf("./results/figures/petal_UV_descriptors_histograms.pdf", width = 14, height = 10)

# Set up plotting area: 4 rows x 6 columns for histograms
par(mfrow = c(4, 6),        # 4 rows, 6 columns
    mar = c(5, 5, 4, 2) + 0.1,  # Margins for each plot: bottom, left, top, right
    oma = c(0, 0, 0, 5))    # Outer margins: bottom, left, top, right

# Loop through each metric and plot histogram with parental lines
for (i in 1:ncol(summary_petal_UV)) {
  
  if (!any(!is.na(summary_petal_UV[, i]))) next  # Skip columns that are entirely NA

  hist(summary_petal_UV[, i], 
       xlab = colnames(summary_petal_UV)[i], 
       main = colnames(summary_petal_UV)[i],
       col = "lightgrey", 
       border = "white")
  
  # Add vertical lines for parental samples
  abline(v = petal125[i], col = 'gold1', lwd = 3)      # C. lasius parent
  abline(v = petal126[i], col = 'gold1', lwd = 3)      # C. lasius parent
  abline(v = petalBRAC[i], col = 'darkgreen', lwd = 3) # C. bracteatus parent
}

# Allow drawing in the outer margin
par(xpd = TRUE)

plot.new()

# Add a shared legend in the outer right margin
legend("topright",
       inset = c(0, 0),  # Adjusts the position of the legend
       legend = c("C. lasius parent", "C. bracteatus parent"),
       col = c("gold1", "darkgreen"),
       lty = 1,              # Line type: solid
       lwd = 3,              # Line width
       cex = 1.5,            # Text size
       bty = "n")            # No box around the legend

# Close the PDF device to save the file
dev.off()
```

### Labellum Summary
```{r labellum-summary UV}
# Calculate summary statistics for labellum
summary_labellum_UV <- summary(labellum_spec_scaleminmax)

# Remove S2 due to infinite values
summary_labellum_UV <- summary_labellum_UV %>% select(-S2)

# Extract metrics for specific samples
labellum125 <- round(summary_labellum_UV["125", ], 3)
labellum126 <- round(summary_labellum_UV["126", ], 3)
labellumBRAC <- round(summary_labellum_UV["BRAC", ], 3)
```

### Plot Labellum Spectral Descriptors Histograms
```{r plot-labellum-hist UV}
pdf("./results/figures/labellum_UV_descriptors_histograms.pdf", width = 14, height = 10)

# Set up plotting area: 4 rows x 6 columns for histograms
par(mfrow = c(4, 6),        # 4 rows, 6 columns
    mar = c(5, 5, 4, 2) + 0.1,  # Margins for each plot: bottom, left, top, right
    oma = c(0, 0, 0, 5))    # Outer margins: bottom, left, top, right

# Loop through each metric and plot histogram with parental lines
for (i in 1:ncol(summary_labellum_UV)) {
  
  if (!any(!is.na(summary_labellum_UV[, i]))) next  # Skip columns that are entirely NA

  hist(summary_labellum_UV[, i], 
       xlab = colnames(summary_labellum_UV)[i], 
       main = colnames(summary_labellum_UV)[i],
       col = "lightgrey", 
       border = "white")
  
  # Add vertical lines for parental samples
  abline(v = labellum125[i], col = 'gold1', lwd = 3)      # C. lasius parent
  abline(v = labellum126[i], col = 'gold1', lwd = 3)      # C. lasius parent
  abline(v = labellumBRAC[i], col = 'darkgreen', lwd = 3) # C. bracteatus parent
}

# Allow drawing in the outer margin
par(xpd = TRUE)

plot.new()

# Add a shared legend in the outer right margin
legend("topright",
       inset = c(0, 0),  # Adjusts the position of the legend
       legend = c("C. lasius parent", "C. bracteatus parent"),
       col = c("gold1", "darkgreen"),
       lty = 1,              # Line type: solid
       lwd = 3,              # Line width
       cex = 1.5,            # Text size
       bty = "n")            # No box around the legend

# Close the PDF device to save the file
dev.off()
```

## Data Formatting and Export
## Reformat Rownames
Replace 'x' with '_' in row names for consistency.
```{r }
# Replace 'x' with '_' in row names
rownames(summary_bract_UV) <- gsub("x", "_", rownames(summary_bract_UV))
rownames(summary_petal_UV) <- gsub("x", "_", rownames(summary_petal_UV))
rownames(summary_labellum_UV) <- gsub("x", "_", rownames(summary_labellum_UV))
```

## Convert Rownames to a Column
Add the row names as a new column id to facilitate merging.
```{r convert UV}
# Convert row names to a column named 'id'
summary_petal_UV <- summary_petal_UV %>% rownames_to_column(var = "id")
summary_labellum_UV <- summary_labellum_UV %>% rownames_to_column(var = "id")
```

## Subset and Rename Columns
Select relevant metrics and rename columns to indicate their corresponding floral tissue.
```{r select-rename UV}
# Subset relevant columns based on analysis needs
summary_petal_UV <- summary_petal_UV[, c("id", "H1")]
summary_labellum_UV <- summary_labellum_UV[, c("id", "H1")]

# Rename columns to include tissue type
colnames(summary_petal_UV) <- c("id", "H1_UV_petal")
colnames(summary_labellum_UV) <- c("id", "H1_UV_labellum")
```


# Vision Models
```{r}

```

# Merge Dataframes
```{r merge UV}
# Merge all summaries by 'id'
joined_df <- pca_bract %>%
  full_join(pca_petal, by = "id") %>%
  full_join(pca_labellum, by = "id") %>%
  full_join(summary_bract, by = "id") %>%
  full_join(summary_petal, by = "id") %>%
  full_join(summary_labellum, by = "id") %>%
  full_join(summary_petal_UV, by = "id") %>%
  full_join(summary_labellum_UV, by = "id")
```

# Export Summary Descriptors to CSV
Save the combined summary descriptors to a CSV file for further analysis or reporting.
```{r export UV}
# Write the combined summary dataframe to a CSV file
write.csv(joined_df, "./results/processed_data/color_traits.csv", 
          quote = FALSE, row.names = FALSE)
```



